<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compras TQ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  const firebaseConfig = {
    apiKey: "AIzaSyC3bi23d54_c9Hwu0XDass8tRwJ3fAY3dc",
    authDomain: "bdd-compras-uptq.firebaseapp.com",
    projectId: "bdd-compras-uptq",
    storageBucket: "bdd-compras-uptq.firebasestorage.app",
    messagingSenderId: "862773575107",
    appId: "1:862773575107:web:599d678b8ae2b1d7b15176"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  window._fb = { db, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc };
</script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f5f7ff;
  --surface: #ffffff;
  --navy: #2d3a5e;
  --accent: #6c63ff;
  --border: #e8eaf6;
  --text: #2d3a5e;
  --muted: #8f96b3;
  --shadow: 0 2px 8px rgba(108,99,255,0.07), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 6px 24px rgba(108,99,255,0.13);
  --radius: 16px;
}
body { font-family: 'Nunito', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
#root { min-height: 100vh; }

/* ‚îÄ‚îÄ NAVBAR ‚îÄ‚îÄ */
.navbar {
  background: var(--surface); border-bottom: 1px solid var(--border);
  padding: 0 2rem; height: 64px;
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 100;
  box-shadow: 0 2px 12px rgba(108,99,255,0.07);
}
.navbar-brand { font-size: 1.25rem; font-weight: 900; color: var(--navy); display: flex; align-items: center; gap: 10px; letter-spacing: -0.3px; }
.brand-dot { color: var(--accent); }
.nav-logo { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg,#a78bfa,#6c63ff); display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 8px rgba(108,99,255,0.35); }
.navbar-right { display: flex; align-items: center; gap: 10px; }
.btn-admin { background: #f3f0ff; color: var(--accent); border: 1.5px solid #ddd6fe; padding: 7px 16px; border-radius: 10px; font-size: .875rem; font-weight: 700; cursor: pointer; font-family: 'Nunito',sans-serif; display: flex; align-items: center; gap: 6px; transition: all .2s; }
.btn-admin:hover { background: #ede9fe; }
.btn-admin.on { background: var(--accent); color: white; border-color: var(--accent); }
.btn-primary { background: linear-gradient(135deg,#818cf8,#6c63ff); color: white; border: none; padding: 9px 20px; border-radius: 10px; font-size: .9rem; font-weight: 800; cursor: pointer; font-family: 'Nunito',sans-serif; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 10px rgba(108,99,255,.35); transition: all .2s; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(108,99,255,.45); }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main { max-width: 1100px; margin: 0 auto; padding: 2rem 1.5rem; }

/* ‚îÄ‚îÄ TABS (admin) ‚îÄ‚îÄ */
.tabs { display: flex; gap: 6px; margin-bottom: 1.5rem; }
.tab-btn { padding: 8px 20px; border-radius: 20px; border: 1.5px solid var(--border); background: white; cursor: pointer; font-size: .875rem; font-weight: 700; font-family: 'Nunito',sans-serif; color: var(--muted); transition: all .18s; }
.tab-btn:hover { border-color: var(--accent); color: var(--accent); }
.tab-btn.act { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 2px 8px rgba(108,99,255,.3); }

/* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
.stats-grid { display: grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap: 14px; margin-bottom: 2rem; }
.stat-card { border-radius: var(--radius); padding: 1.2rem 1.3rem 1rem; border: 1.5px solid transparent; display: flex; flex-direction: column; gap: 10px; transition: transform .2s,box-shadow .2s; }
.stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
.sc-pink   { background: #fff0f6; border-color: #ffd6e8; }
.sc-orange { background: #fff8ed; border-color: #fde8c8; }
.sc-blue   { background: #eef4ff; border-color: #c7d9ff; }
.sc-green  { background: #edfff5; border-color: #a7f3cc; }
.stat-row { display: flex; justify-content: space-between; align-items: flex-start; }
.stat-num { font-size: 2.4rem; font-weight: 900; line-height: 1; letter-spacing: -2px; }
.sc-pink .stat-num   { color: #db2777; }
.sc-orange .stat-num { color: #ea580c; }
.sc-blue .stat-num   { color: #2563eb; }
.sc-green .stat-num  { color: #16a34a; }
.stat-icon-pill { padding: 5px 10px; border-radius: 20px; font-size: .75rem; font-weight: 800; display: flex; align-items: center; gap: 4px; }
.sc-pink .stat-icon-pill   { background: #fce7f3; color: #be185d; }
.sc-orange .stat-icon-pill { background: #ffedd5; color: #c2410c; }
.sc-blue .stat-icon-pill   { background: #dbeafe; color: #1d4ed8; }
.sc-green .stat-icon-pill  { background: #dcfce7; color: #15803d; }
.stat-label { font-size: .78rem; font-weight: 700; letter-spacing: .04em; text-transform: uppercase; }
.sc-pink .stat-label   { color: #db2777; }
.sc-orange .stat-label { color: #ea580c; }
.sc-blue .stat-label   { color: #2563eb; }
.sc-green .stat-label  { color: #16a34a; }

/* ‚îÄ‚îÄ PROVIDER DATABASE ‚îÄ‚îÄ */
.pdb-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap: 14px; margin-bottom: 1.5rem; }
.pdb-card { background: white; border-radius: 14px; border: 1.5px solid var(--border); box-shadow: var(--shadow); overflow: hidden; transition: box-shadow .18s,transform .18s; }
.pdb-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
.pdb-card-head { padding: .9rem 1.1rem .7rem; background: linear-gradient(135deg,#f8f7ff,#f0eeff); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.pdb-card-name { font-weight: 900; font-size: 1rem; color: var(--navy); display: flex; align-items: center; gap: 7px; }
.pdb-card-body { padding: .8rem 1.1rem; display: flex; flex-direction: column; gap: 4px; }
.pdb-field { display: flex; gap: 8px; font-size: .78rem; }
.pdb-field-lbl { color: var(--muted); font-weight: 700; min-width: 80px; flex-shrink: 0; }
.pdb-field-val { color: var(--navy); font-weight: 600; word-break: break-all; }
.pdb-field-val a { color: var(--accent); text-decoration: none; }
.pdb-field-val a:hover { text-decoration: underline; }
.pdb-card-actions { padding: .6rem 1.1rem .8rem; display: flex; gap: 7px; }
.pdb-btn-edit { background: #f3f0ff; color: var(--accent); border: 1.5px solid #ddd6fe; border-radius: 8px; padding: 5px 12px; font-size: .75rem; font-weight: 800; cursor: pointer; font-family: 'Nunito',sans-serif; transition: all .15s; }
.pdb-btn-edit:hover { background: #ede9fe; }
.pdb-btn-del { background: #fff0f6; color: #e11d48; border: 1.5px solid #fecdd3; border-radius: 8px; padding: 5px 9px; font-size: .75rem; font-weight: 800; cursor: pointer; font-family: 'Nunito',sans-serif; transition: all .15s; }
.pdb-btn-del:hover { background: #fce7f3; }
.pdb-modal-overlay { position: fixed; inset: 0; background: rgba(45,58,94,.45); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(3px); }
.pdb-modal { background: white; border-radius: 20px; box-shadow: var(--shadow-md); padding: 1.75rem; width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto; }
.pdb-modal h3 { font-size: 1.1rem; font-weight: 900; color: var(--navy); margin-bottom: 1.2rem; }
.pdb-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.pdb-form-grid .full { grid-column: span 2; }
.yellow-hint { font-size: .7rem; color: #b45309; font-weight: 700; background: #fef9c3; border: 1px solid #fde68a; border-radius: 6px; padding: 4px 9px; margin-top: 4px; display: inline-block; }

/* ‚îÄ‚îÄ PROJECT MANAGER ‚îÄ‚îÄ */
.pm-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
.pm-title { font-size: 1.1rem; font-weight: 900; color: var(--navy); }
.pm-subtitle { font-size: .8rem; color: var(--muted); font-weight: 600; margin-top: 2px; }
.pm-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap: 12px; margin-bottom: 1.5rem; }
.pm-card { background: white; border-radius: 14px; border: 1.5px solid var(--border); padding: 1rem 1.25rem; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: space-between; gap: 10px; transition: box-shadow .18s; }
.pm-card:hover { box-shadow: var(--shadow-md); }
.pm-card-info { flex: 1; min-width: 0; }
.pm-card-name { font-weight: 800; font-size: .95rem; color: var(--navy); margin-bottom: 3px; display: flex; align-items: center; gap: 6px; }
.pm-card-desc { font-size: .75rem; color: var(--muted); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pm-card-meta { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.pm-status-pill { font-size: .7rem; font-weight: 800; padding: 3px 10px; border-radius: 20px; }
.pm-status-pill.active   { background: #dcfce7; color: #15803d; }
.pm-status-pill.inactive { background: #f1f5f9; color: #64748b; }
.pm-btn-toggle { background: none; border: 1.5px solid var(--border); border-radius: 8px; padding: 5px 10px; font-size: .72rem; font-weight: 800; cursor: pointer; font-family: 'Nunito',sans-serif; color: var(--muted); transition: all .15s; }
.pm-btn-toggle:hover { border-color: var(--accent); color: var(--accent); }
.pm-btn-del { background: none; border: 1.5px solid #fecdd3; border-radius: 8px; padding: 5px 8px; font-size: .75rem; cursor: pointer; color: #e11d48; transition: all .15s; }
.pm-btn-del:hover { background: #fff0f6; }
.pm-add-form { background: var(--bg); border-radius: 14px; border: 1.5px dashed var(--border); padding: 1.25rem; }
.pm-add-title { font-size: .8rem; font-weight: 800; text-transform: uppercase; letter-spacing: .05em; color: var(--muted); margin-bottom: 10px; }
.pm-add-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
.pm-add-row .form-group { flex: 1; min-width: 160px; margin-bottom: 0; }
.pm-empty { text-align: center; padding: 2.5rem; color: var(--muted); font-size: .9rem; font-weight: 600; }

/* select styled */
select.form-input { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238f96b3' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; cursor: pointer; }

/* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
.filters-section { margin-bottom: 1.25rem; }
.search-wrap { position: relative; margin-bottom: 12px; }
.search-wrap input { width: 100%; max-width: 400px; padding: 10px 14px 10px 40px; border: 1.5px solid var(--border); border-radius: 12px; font-size: .9rem; font-family: 'Nunito',sans-serif; font-weight: 600; background: white; outline: none; color: var(--text); transition: border-color .2s,box-shadow .2s; }
.search-wrap input::placeholder { color: var(--muted); font-weight: 500; }
.search-wrap input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(108,99,255,.1); }
.search-icon { position: absolute; left: 13px; top: 50%; transform: translateY(-50%); font-size: 15px; }
.filter-pills { display: flex; gap: 6px; flex-wrap: wrap; }
.filter-btn { padding: 6px 14px; border-radius: 20px; border: 1.5px solid var(--border); background: white; cursor: pointer; font-size: .82rem; font-weight: 700; font-family: 'Nunito',sans-serif; color: var(--muted); transition: all .15s; white-space: nowrap; }
.filter-btn:hover { border-color: var(--accent); color: var(--accent); background: #f3f0ff; }
.filter-btn.act { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 2px 8px rgba(108,99,255,.28); }

/* ‚îÄ‚îÄ ORDER CARDS ‚îÄ‚îÄ */
.orders-list { display: flex; flex-direction: column; gap: 10px; }
.order-card { background: white; border-radius: var(--radius); padding: 1.1rem 1.4rem; border: 1.5px solid var(--border); cursor: pointer; transition: all .18s; display: flex; align-items: center; justify-content: space-between; gap: 1rem; box-shadow: var(--shadow); }
.order-card:hover { border-color: #c7d2fe; box-shadow: var(--shadow-md); transform: translateY(-1px); }
.order-card-left { flex: 1; min-width: 0; }
.order-meta { display: flex; align-items: center; gap: 7px; margin-bottom: 7px; flex-wrap: wrap; }
.order-id { font-weight: 900; font-size: .92rem; color: var(--accent); }
.order-date { font-size: .78rem; color: var(--muted); font-weight: 600; }
.order-proj { font-size: .78rem; color: #6c63ff; font-weight: 700; background: #f3f0ff; padding: 2px 8px; border-radius: 20px; }
.order-info { display: flex; gap: 18px; font-size: .8rem; color: var(--muted); margin-bottom: 6px; font-weight: 600; }
.order-info span b { color: var(--text); font-weight: 800; }
.order-chips { display: flex; gap: 5px; flex-wrap: wrap; }
.chip { font-size: .75rem; background: var(--bg); color: var(--muted); padding: 2px 9px; border-radius: 20px; font-weight: 600; border: 1px solid var(--border); }
.order-right { text-align: right; white-space: nowrap; }
.order-total-num { font-size: 1.2rem; font-weight: 900; color: var(--accent); letter-spacing: -.5px; }
.order-total-lbl { font-size: .7rem; color: var(--muted); font-weight: 700; margin-top: 1px; }

/* ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ */
.tag { padding: 3px 10px; border-radius: 20px; font-size: .73rem; font-weight: 800; }
.tag-cat.reactivos   { background: #dcfce7; color: #15803d; }
.tag-cat.disolventes { background: #ede9fe; color: #6d28d9; }
.tag-cat.gases       { background: #fce7f3; color: #9d174d; }
.tag-cat.racoreria   { background: #dbeafe; color: #1e40af; }
.tag-cat.otros       { background: #fff7ed; color: #c2410c; }
.st-pendiente { background: #fff0f6; color: #be185d; }
.st-revision  { background: #eff6ff; color: #1d4ed8; }
.st-aprobado  { background: #f0fdf4; color: #15803d; }
.st-proceso   { background: #f5f3ff; color: #6d28d9; }
.st-realizado { background: #fff7ed; color: #c2410c; }
.st-recibido  { background: #ecfdf5; color: #047857; }
.st-rechazado { background: #fef2f2; color: #dc2626; }

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty-state { text-align: center; padding: 5rem 2rem; background: white; border-radius: var(--radius); border: 2px dashed var(--border); color: var(--muted); }
.empty-state .big { font-size: 3rem; margin-bottom: 1rem; display: block; }
.empty-state p { font-size: 1rem; font-weight: 700; margin-bottom: 4px; }
.empty-state small { font-size: .82rem; font-weight: 500; }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay { position: fixed; inset: 0; background: rgba(45,58,94,.4); backdrop-filter: blur(5px); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 1rem; animation: fi .15s ease; }
@keyframes fi { from{opacity:0}to{opacity:1} }
.modal { background: white; border-radius: 20px; padding: 2rem; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(45,58,94,.18); animation: su .2s ease; }
.modal-sm { max-width: 400px; }
@keyframes su { from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1} }
.modal h2 { font-size: 1.3rem; font-weight: 900; color: var(--navy); margin-bottom: 1.5rem; letter-spacing: -.3px; }

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
.form-group { margin-bottom: 14px; }
.form-label { font-size: .73rem; font-weight: 800; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); display: block; margin-bottom: 5px; }
.req { color: #f43f5e; }
.opt { color: var(--muted); font-weight: 600; font-size: .68rem; text-transform: none; letter-spacing: 0; }
.form-input { width: 100%; padding: 10px 13px; border: 1.5px solid var(--border); border-radius: 10px; font-size: .9rem; font-family: 'Nunito',sans-serif; font-weight: 600; outline: none; color: var(--text); background: white; transition: border-color .18s,box-shadow .18s; }
.form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(108,99,255,.1); }
textarea.form-input { resize: vertical; min-height: 80px; }

/* ‚îÄ‚îÄ CATEGORY ‚îÄ‚îÄ */
.cat-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 8px; }
.cat-option { border: 1.5px solid var(--border); border-radius: 12px; padding: 10px 6px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; font-size: .77rem; font-weight: 700; color: var(--muted); background: white; transition: all .15s; text-align: center; }
.cat-option .ce { font-size: 1.3rem; }
.cat-option:hover { border-color: var(--accent); background: #f3f0ff; color: var(--accent); }
.cat-option.sel { border-color: var(--accent); background: #ede9fe; color: var(--accent); }
.cat-option input { display: none; }

/* ‚îÄ‚îÄ PRODUCTS ‚îÄ‚îÄ */
.products-header { display: grid; grid-template-columns: 100px 1fr 140px 65px 95px 36px; gap: 8px; padding: 0 4px; margin-bottom: 5px; font-size: .69rem; font-weight: 800; text-transform: uppercase; letter-spacing: .05em; color: var(--muted); }
.product-row { display: grid; grid-template-columns: 100px 1fr 140px 65px 95px 36px; gap: 8px; margin-bottom: 7px; align-items: center; }
.btn-remove { width: 34px; height: 34px; border-radius: 8px; background: #fff0f6; color: #e11d48; border: none; cursor: pointer; font-size: 14px; font-weight: 900; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all .15s; }
.btn-remove:hover { background: #fce7f3; }
.btn-add { background: #f3f0ff; color: var(--accent); border: 1.5px solid #ddd6fe; padding: 7px 14px; border-radius: 8px; font-size: .82rem; font-weight: 800; cursor: pointer; font-family: 'Nunito',sans-serif; transition: all .15s; }
.btn-add:hover { background: #ede9fe; }
.total-line { text-align: right; font-weight: 900; font-size: 1rem; color: var(--accent); margin: 8px 0; letter-spacing: -.3px; }
.modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 1.5rem; padding-top: 1.25rem; border-top: 1.5px solid var(--border); }
.btn-sec { background: white; color: var(--text); border: 1.5px solid var(--border); padding: 9px 20px; border-radius: 10px; font-size: .9rem; font-weight: 700; cursor: pointer; font-family: 'Nunito',sans-serif; transition: all .15s; }
.btn-sec:hover { border-color: var(--muted); }

/* ‚îÄ‚îÄ ADMIN DETAIL ‚îÄ‚îÄ */
.admin-zone { background: #f5f3ff; border: 1.5px solid #ddd6fe; border-radius: 14px; padding: 14px 16px; margin-bottom: 1.4rem; }
.admin-zone-title { font-size: .72rem; font-weight: 800; text-transform: uppercase; letter-spacing: .06em; color: var(--accent); margin-bottom: 10px; }
.admin-actions { display: flex; gap: 7px; flex-wrap: wrap; }
.btn-st { padding: 6px 13px; border-radius: 20px; border: 1.5px solid var(--border); font-size: .78rem; font-weight: 800; cursor: pointer; font-family: 'Nunito',sans-serif; transition: all .15s; background: white; color: var(--muted); }
.btn-st:hover { border-color: var(--accent); color: var(--accent); background: #f3f0ff; }

/* ‚îÄ‚îÄ DETAIL MODAL ‚îÄ‚îÄ */
.detail-section { margin-bottom: 1.2rem; }
.detail-section h3 { font-size: .71rem; font-weight: 800; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); margin-bottom: 8px; }
.detail-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; }
.detail-item { background: var(--bg); border-radius: 10px; padding: 10px 13px; border: 1px solid var(--border); }
.detail-item .lbl { font-size: .69rem; color: var(--muted); font-weight: 700; margin-bottom: 3px; }
.detail-item .val { font-weight: 800; font-size: .9rem; color: var(--text); }
.ptable { width: 100%; border-collapse: collapse; }
.ptable th { font-size: .69rem; text-transform: uppercase; letter-spacing: .05em; color: var(--muted); font-weight: 800; text-align: left; padding: 6px 10px; border-bottom: 1.5px solid var(--border); }
.ptable td { padding: 9px 10px; font-size: .875rem; font-weight: 600; border-bottom: 1px solid var(--bg); }
.ptable tr:last-child td { border-bottom: none; }
.notes-box { background: var(--bg); border-radius: 10px; padding: 11px 14px; font-size: .875rem; color: var(--muted); font-style: italic; font-weight: 600; border: 1px solid var(--border); }

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
.lbox { text-align: center; }
.lbox .sub { color: var(--muted); font-size: .875rem; margin-bottom: 1.5rem; font-weight: 600; }
.err-msg { background: #fff0f6; color: #be185d; border-radius: 8px; padding: 8px 12px; font-size: .85rem; margin-bottom: 12px; font-weight: 700; border: 1px solid #fce7f3; }

/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
.dash-section { background: white; border-radius: var(--radius); border: 1.5px solid var(--border); padding: 1.5rem; margin-bottom: 1.25rem; box-shadow: var(--shadow); }
.dash-section-title { font-size: .8rem; font-weight: 800; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); margin-bottom: 1rem; display: flex; align-items: center; gap: 6px; }
.dash-kpi-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; margin-bottom: 0; }
.dash-kpi { border-radius: 12px; padding: 1rem 1.25rem; border: 1.5px solid transparent; }
.dash-kpi.k-total  { background: #eef4ff; border-color: #c7d9ff; }
.dash-kpi.k-month  { background: #edfff5; border-color: #a7f3cc; }
.dash-kpi.k-avg    { background: #fff8ed; border-color: #fde8c8; }
.dash-kpi .kv { font-size: 1.6rem; font-weight: 900; letter-spacing: -1px; }
.dash-kpi.k-total .kv  { color: #2563eb; }
.dash-kpi.k-month .kv  { color: #16a34a; }
.dash-kpi.k-avg   .kv  { color: #ea580c; }
.dash-kpi .kl { font-size: .72rem; font-weight: 700; text-transform: uppercase; letter-spacing: .04em; margin-top: 2px; }
.dash-kpi.k-total .kl  { color: #2563eb; }
.dash-kpi.k-month .kl  { color: #16a34a; }
.dash-kpi.k-avg   .kl  { color: #ea580c; }
.dash-kpi .ks { font-size: .75rem; color: var(--muted); font-weight: 600; }

/* cat breakdown */
.cat-breakdown { display: grid; grid-template-columns: repeat(5,1fr); gap: 10px; }
.cat-kpi { border-radius: 12px; padding: .9rem 1rem; border: 1.5px solid var(--border); background: var(--bg); }
.cat-kpi .ck-label { font-size: .72rem; font-weight: 800; text-transform: uppercase; letter-spacing: .04em; color: var(--muted); margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
.cat-kpi .ck-val { font-size: 1.1rem; font-weight: 900; color: var(--navy); letter-spacing: -.5px; }
.cat-kpi .ck-pct { font-size: .72rem; font-weight: 700; color: var(--muted); margin-top: 2px; }
.cat-kpi .ck-bar-wrap { height: 4px; background: #e8eaf6; border-radius: 4px; margin-top: 6px; }
.cat-kpi .ck-bar { height: 4px; border-radius: 4px; transition: width .6s ease; }
.ck-reactivos   .ck-bar { background: #22c55e; }
.ck-disolventes .ck-bar { background: #a855f7; }
.ck-gases       .ck-bar { background: #ec4899; }
.ck-racoreria   .ck-bar { background: #3b82f6; }
.ck-otros       .ck-bar { background: #f97316; }

/* chart */
.chart-wrap { display: flex; align-items: flex-end; gap: 6px; height: 120px; margin-top: .5rem; }
.chart-bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; height: 100%; justify-content: flex-end; }
.chart-bar { width: 100%; border-radius: 6px 6px 0 0; min-height: 3px; transition: height .4s ease; background: linear-gradient(180deg,#818cf8,#6c63ff); }
.chart-bar.empty { background: #e8eaf6; }
.chart-month-lbl { font-size: .65rem; font-weight: 700; color: var(--muted); white-space: nowrap; }
.chart-val-lbl { font-size: .6rem; font-weight: 800; color: var(--accent); }

/* monthly table */
.month-table { width: 100%; border-collapse: collapse; font-size: .82rem; }
.month-table th { font-size: .69rem; font-weight: 800; text-transform: uppercase; letter-spacing: .05em; color: var(--muted); padding: 6px 10px; text-align: right; border-bottom: 1.5px solid var(--border); }
.month-table th:first-child { text-align: left; }
.month-table td { padding: 7px 10px; text-align: right; font-weight: 700; border-bottom: 1px solid var(--bg); color: var(--navy); }
.month-table td:first-child { text-align: left; color: var(--muted); font-weight: 800; font-size: .8rem; }
.month-table tr.cur td { background: #f5f3ff; }
.month-table tr.cur td:first-child { color: var(--accent); border-radius: 8px 0 0 8px; }
.month-table .zero { color: #cbd5e1; font-weight: 600; }
.month-table tfoot td { font-weight: 900; color: var(--navy); border-top: 2px solid var(--border); padding-top: 10px; }

/* year badge */
.year-badge { background: var(--navy); color: white; font-size: .75rem; font-weight: 800; padding: 3px 10px; border-radius: 20px; margin-left: auto; }

/* dash sub-tabs */
.dash-tabs { display: flex; gap: 6px; margin-bottom: 1.25rem; }
.dash-tab { padding: 7px 18px; border-radius: 20px; border: 1.5px solid var(--border); background: white; cursor: pointer; font-size: .82rem; font-weight: 700; font-family: 'Nunito',sans-serif; color: var(--muted); transition: all .15s; }
.dash-tab:hover { border-color: var(--accent); color: var(--accent); background: #f3f0ff; }
.dash-tab.act { background: var(--navy); color: white; border-color: var(--navy); }

/* project cards */
.proj-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap: 12px; }
.proj-card { background: white; border-radius: 14px; border: 1.5px solid var(--border); padding: 1.1rem 1.25rem; box-shadow: var(--shadow); transition: transform .18s,box-shadow .18s; }
.proj-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
.proj-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.proj-name { font-size: .95rem; font-weight: 900; color: var(--navy); display: flex; align-items: center; gap: 6px; }
.proj-total { font-size: 1.1rem; font-weight: 900; color: var(--accent); letter-spacing: -.5px; }
.proj-meta { font-size: .75rem; color: var(--muted); font-weight: 600; margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
.proj-cat-bar { display: flex; gap: 2px; height: 6px; border-radius: 6px; overflow: hidden; margin-bottom: 8px; }
.proj-cat-seg { height: 100%; transition: width .4s ease; }
.proj-cat-list { display: flex; flex-wrap: wrap; gap: 4px; }
.proj-cat-chip { font-size: .68rem; font-weight: 800; padding: 2px 7px; border-radius: 20px; }
.proj-bar-wrap2 { height: 5px; background: #e8eaf6; border-radius: 4px; margin-top: 4px; }
.proj-bar2 { height: 5px; border-radius: 4px; background: linear-gradient(90deg,#818cf8,#6c63ff); transition: width .5s ease; }
.proj-table { width: 100%; border-collapse: collapse; font-size: .82rem; }
.proj-table th { font-size: .69rem; font-weight: 800; text-transform: uppercase; letter-spacing: .05em; color: var(--muted); padding: 7px 10px; text-align: left; border-bottom: 1.5px solid var(--border); }
.proj-table td { padding: 9px 10px; font-weight: 600; border-bottom: 1px solid var(--bg); color: var(--navy); vertical-align: middle; }
.proj-table tfoot td { font-weight: 900; border-top: 2px solid var(--border); padding-top: 10px; }

@media(max-width:768px){
  .stats-grid { grid-template-columns: repeat(2,1fr); }
  .cat-grid { grid-template-columns: repeat(3,1fr); }
  .cat-breakdown { grid-template-columns: repeat(3,1fr); }
  .form-row { grid-template-columns: 1fr; }
  .detail-grid { grid-template-columns: repeat(2,1fr); }
  .products-header { display: none; }
  .product-row { grid-template-columns: 1fr 1fr; }
  .dash-kpi-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useMemo } = React;

const ADMIN_PASSWORD = "admin123";

const MONTHS_ES = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

const STATUSES = [
  {key:"todos",    label:"Todos"},
  {key:"pendiente",label:"‚è≥ Pendiente"},
  {key:"revision", label:"üîç En revisi√≥n"},
  {key:"aprobado", label:"‚úÖ Aprobado"},
  {key:"proceso",  label:"üîÑ En proceso"},
  {key:"realizado",label:"üì¶ Pedido realizado"},
  {key:"recibido", label:"‚úîÔ∏è Recibido"},
  {key:"rechazado",label:"‚ùå Rechazado"},
];

const STATUS_LABELS = {
  pendiente:"Pendiente", revision:"En revisi√≥n", aprobado:"Aprobado",
  proceso:"En proceso", realizado:"Pedido realizado",
  recibido:"Recibido", rechazado:"Rechazado",
};
const STATUS_COLORS = {
  pendiente:{bg:"#fff0f6",color:"#be185d"},
  revision: {bg:"#eff6ff",color:"#1d4ed8"},
  aprobado: {bg:"#f0fdf4",color:"#15803d"},
  proceso:  {bg:"#f5f3ff",color:"#6d28d9"},
  realizado:{bg:"#fff7ed",color:"#c2410c"},
  recibido: {bg:"#ecfdf5",color:"#047857"},
  rechazado:{bg:"#fef2f2",color:"#dc2626"},
};

const CATS = [
  {key:"reactivos",  label:"Reactivos",  emoji:"üß™"},
  {key:"disolventes",label:"Disolventes",emoji:"üíß"},
  {key:"gases",      label:"Gases",      emoji:"ü´ß"},
  {key:"racoreria",  label:"Racorer√≠a",  emoji:"üî©"},
  {key:"otros",      label:"Otros",      emoji:"üì¶"},
];
const CAT_COLORS = {reactivos:"#22c55e",disolventes:"#a855f7",gases:"#ec4899",racoreria:"#3b82f6",otros:"#f97316"};

const fmt = d  => new Date(d).toLocaleDateString("es-ES");
const eur = n  => Number(n).toFixed(2)+" ‚Ç¨";
const gid = () => "#"+Math.floor(100000+Math.random()*900000);
const tot = ps => ps.reduce((s,p)=>s+Number(p.unidades)*Number(p.precio),0);
const initialOrders = [];
function getFB(){ return window._fb||null; }

function StatusTag({status}){
  return <span className={`tag st-${status}`}>{STATUS_LABELS[status]||status}</span>;
}
function CatTag({cat}){
  const c=CATS.find(x=>x.key===cat);
  return <span className={`tag tag-cat ${cat}`}>{c?c.emoji+" "+c.label:cat}</span>;
}

/* ‚îÄ‚îÄ NEW REQUEST ‚îÄ‚îÄ */
function NewRequestModal({onClose,onSubmit,proyectos=[],proveedores=[]}){
  const [form,setForm]=useState({responsable:"",proveedor:"",category:"",notas:"",proyecto:""});
  const [prods,setProds]=useState([{codigo:"",nombre:"",unidades:1,precio:0,url:""}]);
  const [err,setErr]=useState("");
  const [provOtro,setProvOtro]=useState(false); // true = writing custom name
  const sf=(k,v)=>setForm(f=>({...f,[k]:v}));
  const sp=(i,k,v)=>setProds(ps=>ps.map((p,idx)=>idx===i?{...p,[k]:v}:p));
  const total=tot(prods);
  const submit=()=>{
    if(!form.responsable.trim()) return setErr("El campo Responsable es obligatorio.");
    if(!form.proveedor.trim())   return setErr("El campo Proveedor es obligatorio.");
    if(!form.category)           return setErr("Selecciona una categor√≠a.");
    if(prods.some(p=>!p.nombre.trim())) return setErr("Completa el nombre de todos los productos.");
    setErr("");
    onSubmit({id:gid(),date:new Date().toISOString().split("T")[0],status:"pendiente",
      category:form.category,responsable:form.responsable,proveedor:form.proveedor,
      notas:form.notas,proyecto:form.proyecto,products:prods});
  };
  return(
    <div className="modal-overlay" onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div className="modal">
        <h2>‚ú® Nueva Solicitud de Compra</h2>
        {err&&<div className="err-msg">‚ö†Ô∏è {err}</div>}
        <div className="form-row">
          <div className="form-group">
            <label className="form-label">Responsable <span className="req">*</span></label>
            <input className="form-input" placeholder="Tu nombre y apellidos" value={form.responsable} onChange={e=>sf("responsable",e.target.value)}/>
          </div>
          <div className="form-group">
            <label className="form-label">Proveedor <span className="req">*</span></label>
            {proveedores.length>0&&!provOtro
              ? <div style={{display:"flex",gap:6}}>
                  <select className="form-input" style={{flex:1}} value={form.proveedor}
                    onChange={e=>{ if(e.target.value==="__otro__"){ setProvOtro(true); sf("proveedor",""); } else { sf("proveedor",e.target.value); } }}>
                    <option value="">‚Äî Selecciona proveedor ‚Äî</option>
                    {proveedores.map(p=><option key={p.id} value={p.nombre}>{p.nombre}</option>)}
                    <option value="__otro__">‚úèÔ∏è Otro (escribir manualmente)‚Ä¶</option>
                  </select>
                </div>
              : <div style={{display:"flex",gap:6,alignItems:"center"}}>
                  <input className="form-input" style={{flex:1}} placeholder="Nombre del proveedor" value={form.proveedor} onChange={e=>sf("proveedor",e.target.value)} autoFocus={provOtro}/>
                  {proveedores.length>0&&<button type="button" onClick={()=>{setProvOtro(false);sf("proveedor","");}} style={{background:"#f1f5f9",color:"var(--muted)",border:"1.5px solid var(--border)",borderRadius:8,padding:"7px 10px",cursor:"pointer",fontSize:".8rem",fontWeight:700,fontFamily:"'Nunito',sans-serif",whiteSpace:"nowrap"}}>‚Üê Lista</button>}
                </div>
            }
          </div>
        </div>
        <div className="form-group" style={{marginTop:14}}>
          <label className="form-label">Categor√≠a <span className="req">*</span></label>
          <div className="cat-grid">
            {CATS.map(c=>(
              <label key={c.key} className={`cat-option${form.category===c.key?" sel":""}`} onClick={()=>sf("category",c.key)}>
                <input type="radio" name="cat" value={c.key} checked={form.category===c.key} onChange={()=>{}}/>
                <span className="ce">{c.emoji}</span>{c.label}
              </label>
            ))}
          </div>
        </div>
        <div className="form-group">
          <label className="form-label">Uso / Observaciones <span className="opt">(obligatorio indicar el uso)</span></label>
          <textarea className="form-input" placeholder="Indica el uso: p.ej. s√≠ntesis de zeolitas, reactivo gen√©rico de laboratorio, calibraci√≥n de equipo, etc." value={form.notas} onChange={e=>sf("notas",e.target.value)}/>
        </div>
        <div className="form-group">
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
            <label className="form-label" style={{marginBottom:0}}>Detalles del pedido <span className="req">*</span></label>
            <button className="btn-add" onClick={()=>setProds(ps=>[...ps,{codigo:"",nombre:"",unidades:1,precio:0,url:""}])}>+ A√±adir producto</button>
          </div>
          <div className="products-header">
            <span>C√≥digo</span><span>Nombre del producto</span><span>URL <span style={{fontWeight:500,fontSize:".65rem"}}>(opcional)</span></span><span>Uds.</span><span>‚Ç¨/ud</span><span></span>
          </div>
          {prods.map((p,i)=>(
            <div className="product-row" key={i}>
              <input className="form-input" placeholder="REF-001" value={p.codigo} onChange={e=>sp(i,"codigo",e.target.value)}/>
              <input className="form-input" placeholder="Nombre del producto" value={p.nombre} onChange={e=>sp(i,"nombre",e.target.value)}/>
              <input className="form-input" placeholder="https://‚Ä¶" value={p.url||""} onChange={e=>sp(i,"url",e.target.value)}/>
              <input className="form-input" type="number" min="1" value={p.unidades} onChange={e=>sp(i,"unidades",e.target.value)}/>
              <input className="form-input" type="number" min="0" step="0.01" value={p.precio} onChange={e=>sp(i,"precio",e.target.value)}/>
              {prods.length>1?<button className="btn-remove" onClick={()=>setProds(ps=>ps.filter((_,idx)=>idx!==i))}>‚úï</button>:<div/>}
            </div>
          ))}
          <div className="total-line">Total estimado: {eur(total)}</div>
        </div>
        <div className="modal-footer">
          <button className="btn-sec" onClick={onClose}>Cancelar</button>
          <button className="btn-primary" onClick={submit}>üíæ Enviar Solicitud</button>
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
function LoginModal({onClose,onSuccess}){
  const [pw,setPw]=useState(""); const [err,setErr]=useState("");
  const go=()=>pw===ADMIN_PASSWORD?onSuccess():setErr("Contrase√±a incorrecta.");
  return(
    <div className="modal-overlay" onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div className="modal modal-sm">
        <div className="lbox">
          <h2>üîê Acceso Admin</h2>
          <p className="sub">Introduce la contrase√±a para gestionar los pedidos</p>
          {err&&<div className="err-msg">{err}</div>}
          <input className="form-input" type="password" placeholder="Contrase√±a" value={pw}
            onChange={e=>setPw(e.target.value)} onKeyDown={e=>e.key==="Enter"&&go()} autoFocus/>
          <div className="modal-footer" style={{justifyContent:"space-between"}}>
            <button className="btn-sec" onClick={onClose}>Cancelar</button>
            <button className="btn-primary" onClick={go}>Entrar ‚Üí</button>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ ORDER DETAIL ‚îÄ‚îÄ */
function OrderDetailModal({order,isAdmin,onClose,onStatusChange,onDelete,proyectos=[],onAsignarProyecto}){
  const [confirmDel,setConfirmDel]=useState(false);
  const total=tot(order.products);
  return(
    <div className="modal-overlay" onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div className="modal">
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"1.4rem"}}>
          <div>
            <div style={{display:"flex",gap:7,alignItems:"center",marginBottom:5,flexWrap:"wrap"}}>
              <span style={{fontWeight:900,fontSize:"1.25rem",color:"var(--navy)",letterSpacing:"-.3px"}}>{order.id}</span>
              <StatusTag status={order.status}/>
              <CatTag cat={order.category}/>
            </div>
            <div style={{fontSize:".78rem",color:"var(--muted)",fontWeight:600,display:"flex",gap:12,flexWrap:"wrap"}}>
              <span>üìÖ {fmt(order.date)}</span>
              {order.proyecto&&<span style={{background:"#f3f0ff",color:"var(--accent)",padding:"1px 8px",borderRadius:20,fontWeight:700}}>üìÅ {order.proyecto}</span>}
            </div>
          </div>
          <div style={{textAlign:"right"}}>
            <div style={{fontWeight:900,fontSize:"1.5rem",color:"var(--accent)",letterSpacing:"-.5px"}}>{eur(total)}</div>
            <div style={{fontSize:".7rem",color:"var(--muted)",fontWeight:700,textTransform:"uppercase",letterSpacing:".04em"}}>Total</div>
          </div>
        </div>
        {isAdmin&&(
          <div className="admin-zone">
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
              <div className="admin-zone-title" style={{marginBottom:0}}>‚öôÔ∏è Cambiar estado del pedido</div>
              {!confirmDel
                ?<button onClick={()=>setConfirmDel(true)} style={{background:"#fff0f6",color:"#e11d48",border:"1.5px solid #fecdd3",borderRadius:8,padding:"5px 12px",fontSize:".78rem",fontWeight:800,cursor:"pointer",fontFamily:"'Nunito',sans-serif",display:"flex",alignItems:"center",gap:5}}>üóëÔ∏è Eliminar solicitud</button>
                :<div style={{display:"flex",alignItems:"center",gap:8,background:"#fef2f2",borderRadius:10,padding:"6px 12px",border:"1.5px solid #fecaca"}}>
                  <span style={{fontSize:".78rem",fontWeight:700,color:"#dc2626"}}>¬øSeguro? Esta acci√≥n no se puede deshacer</span>
                  <button onClick={()=>onDelete(order.id)} style={{background:"#dc2626",color:"white",border:"none",borderRadius:7,padding:"5px 12px",fontSize:".78rem",fontWeight:800,cursor:"pointer",fontFamily:"'Nunito',sans-serif"}}>S√≠, eliminar</button>
                  <button onClick={()=>setConfirmDel(false)} style={{background:"white",color:"var(--muted)",border:"1.5px solid var(--border)",borderRadius:7,padding:"5px 10px",fontSize:".78rem",fontWeight:700,cursor:"pointer",fontFamily:"'Nunito',sans-serif"}}>Cancelar</button>
                </div>
              }
            </div>
            <div className="admin-actions">
              {Object.keys(STATUS_LABELS).map(s=>(
                <button key={s} className="btn-st"
                  style={order.status===s?{background:STATUS_COLORS[s]?.bg,color:STATUS_COLORS[s]?.color,borderColor:STATUS_COLORS[s]?.color,boxShadow:"0 2px 6px rgba(0,0,0,.1)"}:{}}
                  onClick={()=>onStatusChange(order.id,s)}>{STATUS_LABELS[s]}</button>
              ))}
            </div>

          </div>
        )}
        <div className="detail-section">
          <h3>Informaci√≥n</h3>
          <div className="detail-grid">
            <div className="detail-item"><div className="lbl">Responsable</div><div className="val">{order.responsable}</div></div>
            <div className="detail-item"><div className="lbl">Proveedor</div><div className="val">{order.proveedor}</div></div>
            <div className="detail-item"><div className="lbl">Categor√≠a</div><div className="val"><CatTag cat={order.category}/></div></div>
            {order.proyecto&&<div className="detail-item" style={{gridColumn:"span 3"}}><div className="lbl">Proyecto</div><div className="val">üìÅ {order.proyecto}</div></div>}
          </div>
        </div>
        {order.notas&&(
          <div className="detail-section">
            <h3>Notas</h3>
            <div className="notes-box">"{order.notas}"</div>
          </div>
        )}
        <div className="detail-section">
          <h3>Art√≠culos ¬∑ {order.products.length}</h3>
          <table className="ptable">
            <thead><tr><th>C√≥digo</th><th>Producto</th><th>URL</th><th>Uds.</th><th>Precio/ud</th><th>Subtotal</th></tr></thead>
            <tbody>
              {order.products.map((p,i)=>(
                <tr key={i}>
                  <td style={{color:"var(--muted)",fontSize:".8rem"}}>{p.codigo||"‚Äî"}</td>
                  <td style={{fontWeight:800}}>{p.nombre}</td>
                  <td>{p.url?<a href={p.url} target="_blank" rel="noreferrer" style={{color:"var(--accent)",fontSize:".75rem",fontWeight:700,textDecoration:"none"}}>üîó Ver</a>:"‚Äî"}</td>
                  <td>{p.unidades}</td>
                  <td>{eur(p.precio)}</td>
                  <td style={{fontWeight:800,color:"var(--accent)"}}>{eur(p.unidades*p.precio)}</td>
                </tr>
              ))}
              <tr style={{background:"var(--bg)"}}>
                <td colSpan="5" style={{textAlign:"right",fontWeight:800,color:"var(--muted)",fontSize:".75rem",textTransform:"uppercase",letterSpacing:".05em"}}>Total</td>
                <td style={{fontWeight:900,color:"var(--accent)",fontSize:"1rem",letterSpacing:"-.3px"}}>{eur(total)}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div className="modal-footer">
          <button className="btn-sec" onClick={onClose}>Cerrar</button>
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
function ProjectView({valid}){
  // group by project name (empty = "Sin proyecto")
  const projectMap = {};
  valid.forEach(o=>{
    const key = (o.proyecto||"").trim()||"__none__";
    if(!projectMap[key]) projectMap[key]=[];
    projectMap[key].push(o);
  });

  const projects = Object.entries(projectMap)
    .map(([name,orders])=>{
      const total = orders.reduce((s,o)=>s+tot(o.products),0);
      const catBreak = {};
      CATS.forEach(c=>{ catBreak[c.key]=orders.filter(o=>o.category===c.key).reduce((s,o)=>s+tot(o.products),0); });
      return {name, orders, total, catBreak};
    })
    .sort((a,b)=>{
      if(a.name==="__none__") return 1;
      if(b.name==="__none__") return -1;
      return b.total-a.total;
    });

  const grandTotal = projects.reduce((s,p)=>s+p.total,0)||1;

  return(
    <div>
      {/* project cards */}
      <div className="dash-section">
        <div className="dash-section-title">üìÅ Resumen por proyecto <span className="year-badge">{projects.filter(p=>p.name!=="__none__").length} proyectos</span></div>
        {projects.length===0
          ?<div style={{color:"var(--muted)",fontWeight:600,padding:"1rem 0",fontSize:".9rem"}}>No hay pedidos con proyecto asignado todav√≠a.</div>
          :<div className="proj-grid">
            {projects.map(p=>{
              const catWithVal = CATS.filter(c=>p.catBreak[c.key]>0);
              const pNone = p.name==="__none__";
              return(
                <div key={p.name} className="proj-card">
                  <div className="proj-card-header">
                    <div className="proj-name">{pNone?"üì¶":"üìÅ"} {pNone?"Sin proyecto":p.name}</div>
                    <div className="proj-total">{eur(p.total)}</div>
                  </div>
                  <div className="proj-meta">
                    <span>üßæ {p.orders.length} pedido{p.orders.length!==1?"s":""}</span>
                    <span>üë§ {[...new Set(p.orders.map(o=>o.responsable))].slice(0,2).join(", ")}{[...new Set(p.orders.map(o=>o.responsable))].length>2?" +‚Ä¶":""}</span>
                  </div>
                  {/* cat color bar */}
                  <div className="proj-cat-bar">
                    {catWithVal.map(c=>(
                      <div key={c.key} className="proj-cat-seg" style={{width:`${(p.catBreak[c.key]/p.total)*100}%`,background:CAT_COLORS[c.key]}}/>
                    ))}
                    {catWithVal.length===0&&<div style={{width:"100%",background:"#e8eaf6",height:"100%"}}/>}
                  </div>
                  <div className="proj-cat-list">
                    {catWithVal.map(c=>{
                      const cat=CATS.find(x=>x.key===c.key);
                      return <span key={c.key} className="proj-cat-chip" style={{background:CAT_COLORS[c.key]+"22",color:CAT_COLORS[c.key]}}>{cat.emoji} {eur(p.catBreak[c.key])}</span>;
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        }
      </div>

      {/* project table */}
      <div className="dash-section">
        <div className="dash-section-title">üìã Tabla de proyectos</div>
        <div style={{overflowX:"auto"}}>
          <table className="proj-table">
            <thead>
              <tr>
                <th>Proyecto</th>
                <th>Responsables</th>
                <th>Pedidos</th>
                {CATS.map(c=><th key={c.key} style={{textAlign:"right",color:CAT_COLORS[c.key]}}>{c.emoji} {c.label}</th>)}
                <th style={{textAlign:"right"}}>Total</th>
              </tr>
            </thead>
            <tbody>
              {projects.map(p=>{
                const pNone=p.name==="__none__";
                const resps=[...new Set(p.orders.map(o=>o.responsable))];
                return(
                  <tr key={p.name}>
                    <td style={{fontWeight:pNone?600:800,color:pNone?"var(--muted)":"var(--navy)",fontStyle:pNone?"italic":"normal"}}>
                      {pNone?"Sin proyecto":p.name}
                    </td>
                    <td style={{color:"var(--muted)",fontSize:".78rem"}}>{resps.slice(0,2).join(", ")}{resps.length>2?` +${resps.length-2}`:""}</td>
                    <td style={{textAlign:"center",color:"var(--muted)"}}>{p.orders.length}</td>
                    {CATS.map(c=>(
                      <td key={c.key} style={{textAlign:"right",color:p.catBreak[c.key]>0?CAT_COLORS[c.key]:"#cbd5e1",fontWeight:p.catBreak[c.key]>0?800:500}}>
                        {p.catBreak[c.key]===0?"‚Äî":eur(p.catBreak[c.key])}
                      </td>
                    ))}
                    <td style={{textAlign:"right",fontWeight:900,color:"var(--accent)"}}>{eur(p.total)}</td>
                  </tr>
                );
              })}
            </tbody>
            <tfoot>
              <tr>
                <td>TOTAL</td>
                <td></td>
                <td style={{textAlign:"center"}}>{valid.length}</td>
                {CATS.map(c=>{const cv=projects.reduce((s,p)=>s+p.catBreak[c.key],0);return<td key={c.key} style={{textAlign:"right",color:cv>0?CAT_COLORS[c.key]:"#cbd5e1",fontWeight:cv>0?900:500}}>{cv===0?"‚Äî":eur(cv)}</td>;})}
                <td style={{textAlign:"right",color:"var(--accent)"}}>{eur(projects.reduce((s,p)=>s+p.total,0))}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  );
}

function Dashboard({orders,proyectos=[],onAsignarProyecto,proveedores=[]}){
  const [dashTab,setDashTab]=useState("gasto");
  const year = new Date().getFullYear();
  const curMonth = new Date().getMonth();

  const valid = orders.filter(o=>o.status!=="rechazado");

  const totalYear = valid.filter(o=>new Date(o.date).getFullYear()===year).reduce((s,o)=>s+tot(o.products),0);
  const totalMonth = valid.filter(o=>{const d=new Date(o.date);return d.getFullYear()===year&&d.getMonth()===curMonth;}).reduce((s,o)=>s+tot(o.products),0);
  const avgMonth = totalYear / 12;

  const monthlyTotals = MONTHS_ES.map((_,mi)=>(
    valid.filter(o=>{const d=new Date(o.date);return d.getFullYear()===year&&d.getMonth()===mi;})
      .reduce((s,o)=>s+tot(o.products),0)
  ));
  const maxM = Math.max(...monthlyTotals,1);

  const catTotals = {};
  CATS.forEach(c=>{catTotals[c.key]=valid.filter(o=>new Date(o.date).getFullYear()===year&&o.category===c.key).reduce((s,o)=>s+tot(o.products),0);});
  const grandTotal = Object.values(catTotals).reduce((s,v)=>s+v,0)||1;

  const monthCatTable = MONTHS_ES.map((_,mi)=>{
    const row={};
    CATS.forEach(c=>{
      row[c.key]=valid.filter(o=>{const d=new Date(o.date);return d.getFullYear()===year&&d.getMonth()===mi&&o.category===c.key;}).reduce((s,o)=>s+tot(o.products),0);
    });
    row._total=CATS.reduce((s,c)=>s+row[c.key],0);
    return row;
  });
  const colTotals={};
  CATS.forEach(c=>{colTotals[c.key]=monthCatTable.reduce((s,r)=>s+r[c.key],0);});
  colTotals._total=CATS.reduce((s,c)=>s+colTotals[c.key],0);

  return(
    <div>
      {/* KPIs always visible */}
      <div className="dash-section">
        <div className="dash-section-title">üìä Control de Gasto <span style={{color:"var(--muted)",fontSize:".7rem",marginLeft:4,fontWeight:600}}>Pedidos no rechazados ¬∑ {year}</span> <span className="year-badge">{year}</span></div>
        <div className="dash-kpi-grid">
          <div className="dash-kpi k-total"><div className="kv">{eur(totalYear)}</div><div className="kl">Total {year}</div><div className="ks">{valid.filter(o=>new Date(o.date).getFullYear()===year).length} pedidos</div></div>
          <div className="dash-kpi k-month"><div className="kv">{eur(totalMonth)}</div><div className="kl">Mes actual</div><div className="ks">{MONTHS_ES[curMonth]} {year}</div></div>
          <div className="dash-kpi k-avg"><div className="kv">{eur(avgMonth)}</div><div className="kl">Media mensual</div><div className="ks">Promedio anual</div></div>
        </div>
      </div>

      {/* sub-tabs */}
      <div className="dash-tabs">
        <button className={`dash-tab${dashTab==="gasto"?" act":""}`} onClick={()=>setDashTab("gasto")}>üìà Por categor√≠a</button>
        <button className={`dash-tab${dashTab==="proyecto"?" act":""}`} onClick={()=>setDashTab("proyecto")}>üìÅ Por proyecto</button>
        <button className={`dash-tab${dashTab==="proveedor"?" act":""}`} onClick={()=>setDashTab("proveedor")}>üè™ Por proveedor</button>
      </div>

      {dashTab==="proveedor" ? (
        <ProveedorView valid={valid} proyectos={proyectos} onAsignarProyecto={onAsignarProyecto} proveedores={proveedores}/>
      ) : dashTab==="gasto" ? (
        <div>
          {/* Category breakdown */}
          <div className="dash-section">
            <div className="dash-section-title">üóÇÔ∏è Por categor√≠a</div>
            <div className="cat-breakdown">
              {CATS.map(c=>(
                <div key={c.key} className={`cat-kpi ck-${c.key}`}>
                  <div className="ck-label" style={{color:CAT_COLORS[c.key]}}>{c.emoji} {c.label}</div>
                  <div className="ck-val">{eur(catTotals[c.key])}</div>
                  <div className="ck-pct">{grandTotal>0?((catTotals[c.key]/grandTotal)*100).toFixed(1):0}%</div>
                  <div className="ck-bar-wrap"><div className="ck-bar" style={{width:`${grandTotal>0?(catTotals[c.key]/grandTotal)*100:0}%`,background:CAT_COLORS[c.key]}}/></div>
                </div>
              ))}
            </div>
          </div>

          {/* Chart */}
          <div className="dash-section">
            <div className="dash-section-title">üìà Gasto mensual {year}</div>
            <div className="chart-wrap">
              {monthlyTotals.map((v,i)=>(
                <div key={i} className="chart-bar-col">
                  {v>0&&<div className="chart-val-lbl">{v>=1000?(v/1000).toFixed(1)+"k":v.toFixed(0)}</div>}
                  <div className={`chart-bar${v===0?" empty":""}`} style={{height:`${Math.max((v/maxM)*100,v>0?8:3)}%`,background:i===curMonth?"linear-gradient(180deg,#a78bfa,#6c63ff)":v===0?"#e8eaf6":"linear-gradient(180deg,#93c5fd,#3b82f6)"}}/>
                  <div className="chart-month-lbl" style={{color:i===curMonth?"var(--accent)":""}}>{MONTHS_ES[i]}</div>
                </div>
              ))}
            </div>
          </div>

          {/* Monthly table */}
          <div className="dash-section">
            <div className="dash-section-title">üìã Desglose mensual por categor√≠a</div>
            <div style={{overflowX:"auto"}}>
              <table className="month-table">
                <thead>
                  <tr>
                    <th>Mes</th>
                    {CATS.map(c=><th key={c.key} style={{color:CAT_COLORS[c.key]}}>{c.emoji} {c.label}</th>)}
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  {monthCatTable.map((row,mi)=>(
                    <tr key={mi} className={mi===curMonth?"cur":""}>
                      <td>{MONTHS_ES[mi]}</td>
                      {CATS.map(c=><td key={c.key} className={row[c.key]===0?"zero":""}>{row[c.key]===0?"‚Äî":eur(row[c.key])}</td>)}
                      <td style={{color:row._total>0?"var(--accent)":"",fontWeight:row._total>0?900:600}} className={row._total===0?"zero":""}>{row._total===0?"‚Äî":eur(row._total)}</td>
                    </tr>
                  ))}
                </tbody>
                <tfoot>
                  <tr>
                    <td style={{color:"var(--navy)"}}>TOTAL</td>
                    {CATS.map(c=><td key={c.key} style={{color:CAT_COLORS[c.key]}}>{colTotals[c.key]===0?"‚Äî":eur(colTotals[c.key])}</td>)}
                    <td style={{color:"var(--accent)"}}>{colTotals._total===0?"‚Äî":eur(colTotals._total)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      ) : (
        <ProjectView valid={valid}/>
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ PROVEEDOR VIEW ‚îÄ‚îÄ */
function ProveedorView({valid,proyectos=[],onAsignarProyecto,proveedores=[]}){
  // group by proveedor
  const provMap={};
  valid.forEach(o=>{
    const k=o.proveedor||"Sin proveedor";
    if(!provMap[k]) provMap[k]=[];
    provMap[k].push(o);
  });
  const pvList=Object.entries(provMap)
    .map(([name,orders])=>({name,orders,total:orders.reduce((s,o)=>s+tot(o.products),0)}))
    .sort((a,b)=>b.total-a.total);

  if(pvList.length===0) return(
    <div className="dash-section"><div style={{textAlign:"center",padding:"2rem",color:"var(--muted)",fontWeight:600}}>No hay pedidos todav√≠a.</div></div>
  );

  return(
    <div>
      {pvList.map(pv=>(
        <div key={pv.name} className="dash-section" style={{marginBottom:"1rem"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"1rem",flexWrap:"wrap",gap:12}}>
            <div>
              <div style={{fontWeight:900,fontSize:"1.05rem",color:"var(--navy)",display:"flex",alignItems:"center",gap:8}}>
                üè™ {pv.name}
              </div>
              <div style={{fontSize:".75rem",color:"var(--muted)",fontWeight:600,marginTop:2}}>
                {pv.orders.length} solicitud{pv.orders.length!==1?"es":""} ¬∑ {[...new Set(pv.orders.map(o=>o.responsable))].length} solicitante{[...new Set(pv.orders.map(o=>o.responsable))].length!==1?"s":""}
              </div>
            </div>
            <div style={{display:"flex",alignItems:"center",gap:10,flexWrap:"wrap"}}>
              {/* Project selector for whole proveedor group */}
              <div style={{display:"flex",flexDirection:"column",gap:4,alignItems:"flex-end"}}>
                <div style={{fontSize:".68rem",fontWeight:800,textTransform:"uppercase",letterSpacing:".05em",color:"var(--accent)"}}>üìÅ Asignar proyecto al pedido</div>
                <div style={{display:"flex",gap:8,alignItems:"center"}}>
                  <select
                    className="form-input"
                    style={{minWidth:200,fontSize:".85rem",padding:"7px 30px 7px 11px"}}
                    value={pv.orders[0]?.proyecto||""}
                    onChange={e=>{ pv.orders.forEach(o=>onAsignarProyecto(o.id,e.target.value)); }}
                  >
                    <option value="">‚Äî Sin proyecto ‚Äî</option>
                    {proyectos.filter(p=>p.active).map(p=><option key={p.id} value={p.name}>{p.name}{p.desc?" ¬∑ "+p.desc:""}</option>)}
                  </select>
                  {pv.orders[0]?.proyecto&&<span style={{background:"#f3f0ff",color:"var(--accent)",padding:"4px 12px",borderRadius:20,fontSize:".75rem",fontWeight:800,whiteSpace:"nowrap"}}>üìÅ {pv.orders[0].proyecto}</span>}
                </div>
                {pv.orders[0]?.proyecto&&<div style={{fontSize:".68rem",color:"#15803d",fontWeight:700}}>‚úÖ Pedidos en proceso</div>}
              </div>
              <div style={{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:6}}>
                <div style={{fontWeight:900,fontSize:"1.3rem",color:"var(--accent)",letterSpacing:"-.5px"}}>{eur(pv.total)}</div>
                <button
                  onClick={()=>{ const dbProv=proveedores.find(p=>p.nombre.toLowerCase()===pv.name.toLowerCase()); generatePedidoExcel(pv.name, pv.orders, dbProv||null); }}
                  style={{background:"linear-gradient(135deg,#22c55e,#16a34a)",color:"white",border:"none",borderRadius:9,padding:"7px 14px",fontSize:".78rem",fontWeight:800,cursor:"pointer",fontFamily:"'Nunito',sans-serif",display:"flex",alignItems:"center",gap:6,boxShadow:"0 2px 8px rgba(34,197,94,.35)",whiteSpace:"nowrap"}}
                >üì• Descargar Excel</button>
              </div>
            </div>
          </div>
          <table className="ptable">
            <thead>
              <tr>
                <th>Art√≠culo</th>
                <th>C√≥digo</th>
                <th>URL</th>
                <th>Solicitante</th>
                <th>Uso / Notas</th>
                <th style={{textAlign:"right"}}>Uds.</th>
                <th style={{textAlign:"right"}}>Precio/ud</th>
                <th style={{textAlign:"right"}}>Subtotal</th>
              </tr>
            </thead>
            <tbody>
              {pv.orders.flatMap((o,oi)=>
                o.products.map((p,pi)=>(
                  <tr key={oi+"-"+pi}>
                    <td style={{fontWeight:800}}>{p.nombre}</td>
                    <td style={{color:"var(--muted)",fontSize:".78rem"}}>{p.codigo||"‚Äî"}</td>
                    <td>{p.url?<a href={p.url} target="_blank" rel="noreferrer" style={{color:"var(--accent)",fontSize:".75rem",fontWeight:700,textDecoration:"none"}}>üîó Ver</a>:"‚Äî"}</td>
                    <td style={{fontSize:".8rem",color:"var(--muted)",fontWeight:700}}>{o.responsable}</td>
                    <td style={{fontSize:".78rem",color:"var(--muted)",maxWidth:180,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}} title={o.notas||""}>{o.notas||"‚Äî"}</td>
                    <td style={{textAlign:"right"}}>{p.unidades}</td>
                    <td style={{textAlign:"right"}}>{eur(p.precio)}</td>
                    <td style={{textAlign:"right",fontWeight:800,color:"var(--accent)"}}>{eur(p.unidades*p.precio)}</td>
                  </tr>
                ))
              )}
            </tbody>
            <tfoot>
              <tr>
                <td colSpan="7" style={{textAlign:"right",fontWeight:800,fontSize:".75rem",textTransform:"uppercase",letterSpacing:".05em",color:"var(--muted)"}}>Total {pv.name}</td>
                <td style={{textAlign:"right",fontWeight:900,color:"var(--accent)",fontSize:"1rem"}}>{eur(pv.total)}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      ))}
    </div>
  );
}

/* ‚îÄ‚îÄ PROJECT MANAGER PANEL ‚îÄ‚îÄ */
function ProjectManager({proyectos,setProyectos}){
  const getFBl=getFB;
  const [name,setName]=useState("");
  const [desc,setDesc]=useState("");
  const [errP,setErrP]=useState("");

  const addProj=async()=>{
    if(!name.trim()) return setErrP("El nombre del proyecto es obligatorio.");
    if(proyectos.find(p=>p.name.toLowerCase()===name.trim().toLowerCase())) return setErrP("Ya existe un proyecto con ese nombre.");
    setErrP("");
    const fb=getFBl(); const newP={id:Date.now(),name:name.trim(),desc:desc.trim(),active:true};
    if(fb){ await fb.addDoc(fb.collection(fb.db,"proyectos"),newP); } else { setProyectos(ps=>[...ps,newP]); }
    setName(""); setDesc("");
  };
  const toggle=async p=>{ const fb=getFBl(); if(fb&&p._docId){ await fb.updateDoc(fb.doc(fb.db,"proyectos",p._docId),{active:!p.active}); } else { setProyectos(ps=>ps.map(x=>x.id===p.id?{...x,active:!x.active}:x)); } };
  const del=async p=>{ const fb=getFBl(); if(fb&&p._docId){ await fb.deleteDoc(fb.doc(fb.db,"proyectos",p._docId)); } else { setProyectos(ps=>ps.filter(x=>x.id!==p.id)); } };

  const active=proyectos.filter(p=>p.active);
  const inactive=proyectos.filter(p=>!p.active);

  return(
    <div>
      <div className="pm-header">
        <div>
          <div className="pm-title">üìÅ Gesti√≥n de Proyectos</div>
          <div className="pm-subtitle">Los proyectos activos aparecen en el resumen por proveedor para asignarlos al pedido</div>
        </div>
        <div style={{display:"flex",gap:8,fontSize:".8rem",color:"var(--muted)",fontWeight:700}}>
          <span style={{background:"#dcfce7",color:"#15803d",padding:"4px 12px",borderRadius:20}}>{active.length} activos</span>
          {inactive.length>0&&<span style={{background:"#f1f5f9",color:"#64748b",padding:"4px 12px",borderRadius:20}}>{inactive.length} archivados</span>}
        </div>
      </div>

      {/* active projects */}
      {active.length===0&&inactive.length===0
        ?<div className="pm-empty">üóÇÔ∏è No hay proyectos todav√≠a. A√±ade el primero abajo.</div>
        :<div className="pm-grid">
          {active.map(p=>(
            <div key={p.id} className="pm-card">
              <div className="pm-card-info">
                <div className="pm-card-name">üìÅ {p.name}</div>
                {p.desc&&<div className="pm-card-desc">{p.desc}</div>}
              </div>
              <div className="pm-card-meta">
                <span className="pm-status-pill active">Activo</span>
                <button className="pm-btn-toggle" onClick={()=>toggle(p)} title="Archivar">üì¶</button>
                <button className="pm-btn-del" onClick={()=>del(p)} title="Eliminar">‚úï</button>
              </div>
            </div>
          ))}
        </div>
      }

      {/* archived */}
      {inactive.length>0&&(
        <div style={{marginBottom:"1.25rem"}}>
          <div style={{fontSize:".72rem",fontWeight:800,textTransform:"uppercase",letterSpacing:".05em",color:"var(--muted)",marginBottom:8}}>Archivados</div>
          <div className="pm-grid">
            {inactive.map(p=>(
              <div key={p.id} className="pm-card" style={{opacity:.65}}>
                <div className="pm-card-info">
                  <div className="pm-card-name" style={{color:"var(--muted)"}}>üì¶ {p.name}</div>
                  {p.desc&&<div className="pm-card-desc">{p.desc}</div>}
                </div>
                <div className="pm-card-meta">
                  <span className="pm-status-pill inactive">Archivado</span>
                  <button className="pm-btn-toggle" onClick={()=>toggle(p)} title="Reactivar" style={{color:"#15803d",borderColor:"#a7f3cc"}}>‚ôªÔ∏è</button>
                  <button className="pm-btn-del" onClick={()=>del(p)} title="Eliminar">‚úï</button>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* add form */}
      <div className="pm-add-form">
        <div className="pm-add-title">‚ûï Nuevo proyecto</div>
        {errP&&<div className="err-msg" style={{marginBottom:10}}>‚ö†Ô∏è {errP}</div>}
        <div className="pm-add-row">
          <div className="form-group">
            <label className="form-label">Nombre <span className="req">*</span></label>
            <input className="form-input" placeholder="Ej: TFG Mar√≠a Garc√≠a" value={name} onChange={e=>setName(e.target.value)} onKeyDown={e=>e.key==="Enter"&&addProj()}/>
          </div>
          <div className="form-group">
            <label className="form-label">Descripci√≥n <span className="opt">(opcional)</span></label>
            <input className="form-input" placeholder="Breve descripci√≥n del proyecto" value={desc} onChange={e=>setDesc(e.target.value)} onKeyDown={e=>e.key==="Enter"&&addProj()}/>
          </div>
          <div style={{paddingBottom:2}}>
            <button className="btn-primary" onClick={addProj} style={{height:42,whiteSpace:"nowrap"}}>+ A√±adir</button>
          </div>
        </div>
      </div>
    </div>
  );
}


/* ‚îÄ‚îÄ EXCEL GENERATOR ‚îÄ‚îÄ */
function generatePedidoExcel(proveedor, orders, info) {
  const XLSX = window.XLSX;
  if(!XLSX){ alert("Error: librer√≠a Excel no cargada"); return; }

  const wb = XLSX.utils.book_new();
  const wsData = [];

  // Row 1: empty
  wsData.push([]);
  // Row 2: title
  wsData.push([null,null,null,null,null,"         SOLICITUD DE PEDIDO"]);
  // Row 3-4: empty
  wsData.push([]); wsData.push([]);
  // Row 5: headers
  wsData.push([null,"Direcci√≥n de env√≠o",null,null,null,"Datos de facturaci√≥n",null,"Datos Proveedor"]);
  // Row 6 ‚Äî provider name + address line 1
  const pi = info || {};
  wsData.push([null,"Fundaci√≥n IMDEA Energ√≠a",null,null,null,"Fundaci√≥n IMDEA Energ√≠a",null, pi.nombre||proveedor]);
  // Row 7
  wsData.push([null,"Avenida Ram√≥n de la Sagra 3",null,null,null,"Avda. Ram√≥n de la Sagra, 3",null, pi.direccion||""]);
  // Row 8
  wsData.push([null,"Parque Tecnol√≥gico de M√≥stoles",null,null,null,"Parque Tecnol√≥gico de M√≥stoles",null, pi.ciudad ? (pi.cp ? "("+pi.cp+") "+pi.ciudad : pi.ciudad) : ""]);
  // Row 9
  wsData.push([null,"28935 - M√≥stoles (MADRID)",null,null,null,"28935 M√≥stoles, Madrid",null, ""]);
  // Row 10
  wsData.push([null,"Tel:  91 737 1135",null,null,null,"Tel:  91 737 11 20",null, pi.tel ? "Tel: "+pi.tel : ""]);
  // Row 11
  wsData.push([null,null,null,null,null,"C.I.F: G-84912716",null, pi.fax ? "Fax: "+pi.fax : ""]);
  // Row 12
  wsData.push([null,"Att.: ",null,null,null,null,null, pi.nif ? "NIF: "+pi.nif : ""]);
  // Row 12b ‚Äî email (H12)
  // email added separately via cell write below
  // Row 13
  wsData.push([null,"Unidad:","UPTQ (PLANTA PILOTO o Laboratorio PLANTA 2)"]);
  // Row 14: empty
  wsData.push([]);
  // Row 15: date and order number
  const today = new Date().toLocaleDateString("es-ES");
  wsData.push([null,"FECHA: ",today,null,null,"N¬∫ PEDIDO:","P-XXXXX"]);
  // Row 16: empty
  wsData.push([]);
  // Row 17: table headers
  wsData.push([null,"ITEM","CANTIDAD","REFERENCIA","DESCRIPCION",null,null,null,"PRECIO UNITARIO","DTO.","TOTAL Iva no Incl"]);
  // Row 18: empty (merged with 17)
  wsData.push([]);

  // Rows 19+: items ‚Äî flatten all products from all orders
  let itemNum = 1;
  const firstItemRow = 19;
  let currentRow = firstItemRow;
  const itemRows = [];

  orders.forEach(order => {
    order.products.forEach(p => {
      wsData.push([
        null,
        itemNum,
        Number(p.unidades)||0,
        p.codigo||"",
        p.nombre||"",
        null, null, null,
        Number(p.precio)||0,
        0,
        null  // formula added separately
      ]);
      itemRows.push(currentRow);
      itemNum++;
      currentRow++;
    });
  });

  // Fill up to at least 10 item rows
  while(itemNum <= 10) {
    wsData.push([null, itemNum, null, null, null, null, null, null, null, null, null]);
    itemRows.push(currentRow);
    itemNum++;
    currentRow++;
  }

  const lastItemRow = currentRow - 1;

  // Subtotal row
  wsData.push([null,null,null,null,null,null,null,null,"SUBTOTAL",null,null]);
  const subtotalRow = currentRow; currentRow++;
  // IVA row
  wsData.push([null,null,null,null,null,null,null,null,"IVA",0.21,null]);
  const ivaRow = currentRow; currentRow++;
  // TOTAL row
  wsData.push([null,null,null,null,null,null,null,null,"TOTAL",null,null]);
  const totalRow = currentRow; currentRow++;
  // Plazo / forma pago
  wsData.push([null,null,"PLAZO DE ENTREGA:",null,null,null,null,"Sello de la empresa:"]);
  wsData.push([null,null,"Forma de Pago:"]);

  const ws = XLSX.utils.aoa_to_sheet(wsData);

  // Helper to set yellow fill on a cell
  function yellowCell(ws, addr, value){
    if(!ws[addr]) ws[addr] = {};
    ws[addr].v = value;
    ws[addr].t = "s";
    ws[addr].s = { fill: { fgColor: { rgb: "FFFF00" } } };
  }

  // H12 = email pedidos (yellow)
  yellowCell(ws, "H12", pi.email ? "email pedidos: "+pi.email : "email pedidos:");

  // Add formulas for item totals and subtotal/iva/total
  itemRows.forEach(r => {
    ws["K"+r] = { f: "+(C"+r+"*I"+r+")-(C"+r+"*I"+r+"*J"+r+")", t:"n" };
  });
  ws["K"+subtotalRow] = { f: "SUM(K"+firstItemRow+":K"+lastItemRow+")", t:"n" };
  ws["K"+ivaRow]      = { f: "+K"+subtotalRow+"*J"+ivaRow, t:"n" };
  ws["K"+totalRow]    = { f: "+K"+subtotalRow+"+K"+ivaRow, t:"n" };

  // Merges (mirroring template)
  ws["!merges"] = [
    {s:{r:4,c:1},e:{r:4,c:3}},   // B5:D5
    {s:{r:5,c:1},e:{r:5,c:3}},   // B6:D6
    {s:{r:6,c:1},e:{r:6,c:3}},   // B7:D7
    {s:{r:7,c:1},e:{r:7,c:4}},   // B8:E8
    {s:{r:8,c:1},e:{r:8,c:4}},   // B9:E9
    {s:{r:9,c:1},e:{r:9,c:4}},   // B10:E10
    {s:{r:4,c:7},e:{r:4,c:10}},  // H5:K5
    {s:{r:14,c:2},e:{r:14,c:3}}, // C15:D15
    {s:{r:14,c:6},e:{r:14,c:8}}, // G15:I15
    {s:{r:16,c:1},e:{r:17,c:1}}, // B17:B18
    {s:{r:16,c:2},e:{r:17,c:2}}, // C17:C18
    {s:{r:16,c:3},e:{r:17,c:3}}, // D17:D18
    {s:{r:16,c:4},e:{r:17,c:7}}, // E17:H18
    {s:{r:16,c:8},e:{r:17,c:8}}, // I17:I18
    {s:{r:16,c:9},e:{r:17,c:9}}, // J17:J18
    {s:{r:16,c:10},e:{r:17,c:10}},// K17:K18
  ];

  // Mark H6:H12 yellow (provider data cells)
  ["H6","H7","H8","H9","H10","H11"].forEach(addr=>{
    if(ws[addr]){
      ws[addr].s = { fill: { fgColor: { rgb: "FFFF00" } } };
    } else {
      ws[addr] = { v:"", t:"s", s:{ fill: { fgColor: { rgb: "FFFF00" } } } };
    }
  });

  // Column widths
  ws["!cols"] = [
    {wch:2},    // A
    {wch:8},    // B ITEM
    {wch:12},   // C CANTIDAD
    {wch:20},   // D REFERENCIA
    {wch:30},   // E DESCRIPCI√ìN
    {wch:8},{wch:8},{wch:8}, // F G H
    {wch:14},   // I PRECIO
    {wch:9},    // J DTO
    {wch:16},   // K TOTAL
  ];

  XLSX.utils.book_append_sheet(wb, ws, "Hoja 1");
  const filename = "Pedido_"+proveedor.replace(/[^a-zA-Z0-9]/g,"_")+".xlsx";
  XLSX.writeFile(wb, filename, {cellStyles:true});
}

/* ‚îÄ‚îÄ PROVIDER DATABASE ‚îÄ‚îÄ */
function ProviderDB({proveedores,setProveedores}){
  const emptyForm = {nombre:"",direccion:"",ciudad:"",cp:"",tel:"",fax:"",nif:"",email:""};
  const [showModal,setShowModal] = useState(false);
  const [editing,setEditing]     = useState(null); // null=new, id=edit
  const [form,setForm]           = useState(emptyForm);
  const [err,setErr]             = useState("");

  const sf=(k,v)=>setForm(f=>({...f,[k]:v}));

  const openNew=()=>{ setForm(emptyForm); setEditing(null); setErr(""); setShowModal(true); };
  const openEdit=p=>{ setForm({nombre:p.nombre||"",direccion:p.direccion||"",ciudad:p.ciudad||"",cp:p.cp||"",tel:p.tel||"",fax:p.fax||"",nif:p.nif||"",email:p.email||""}); setEditing(p.id); setErr(""); setShowModal(true); };

  const save=async()=>{
    if(!form.nombre.trim()) return setErr("El nombre del proveedor es obligatorio.");
    const fb=getFB();
    if(editing===null){
      // new
      const exists=proveedores.find(p=>p.nombre.toLowerCase()===form.nombre.trim().toLowerCase());
      if(exists) return setErr("Ya existe un proveedor con ese nombre.");
      const newP={...form,nombre:form.nombre.trim(),id:Date.now()};
      if(fb){ await fb.addDoc(fb.collection(fb.db,"proveedores"),newP); }
      else { setProveedores(ps=>[...ps,newP]); }
    } else {
      // edit
      const p=proveedores.find(x=>x.id===editing);
      const updated={...p,...form,nombre:form.nombre.trim()};
      if(fb&&p?._docId){ await fb.updateDoc(fb.doc(fb.db,"proveedores",p._docId),updated); }
      else { setProveedores(ps=>ps.map(x=>x.id===editing?updated:x)); }
    }
    setShowModal(false);
  };

  const del=async p=>{
    if(!confirm("¬øEliminar proveedor "+p.nombre+"?")) return;
    const fb=getFB();
    if(fb&&p._docId){ await fb.deleteDoc(fb.doc(fb.db,"proveedores",p._docId)); }
    else { setProveedores(ps=>ps.filter(x=>x.id!==p.id)); }
  };

  const fields = [
    {k:"nombre",  lbl:"Nombre *",        full:true,  ph:"Nombre comercial del proveedor"},
    {k:"nif",     lbl:"NIF/CIF",         full:false, ph:"B12345678"},
    {k:"email",   lbl:"Email pedidos",   full:false, ph:"pedidos@proveedor.com"},
    {k:"tel",     lbl:"Tel√©fono",        full:false, ph:"+34 91 000 0000"},
    {k:"fax",     lbl:"Fax",            full:false, ph:"+34 91 000 0001"},
    {k:"direccion",lbl:"Direcci√≥n",      full:true,  ph:"Calle, n√∫mero"},
    {k:"cp",      lbl:"C.P.",           full:false, ph:"28000"},
    {k:"ciudad",  lbl:"Ciudad",         full:false, ph:"Madrid"},
  ];

  return(
    <div>
      <div className="pm-header">
        <div>
          <div className="pm-title">üè™ Base de datos de proveedores</div>
          <div className="pm-subtitle">La info de cada proveedor se usa para rellenar autom√°ticamente el Excel de pedido</div>
        </div>
        <div style={{display:"flex",gap:8,alignItems:"center"}}>
          <span style={{background:"#eef4ff",color:"#2563eb",padding:"4px 12px",borderRadius:20,fontSize:".8rem",fontWeight:700}}>{proveedores.length} proveedores</span>
          <button className="btn-primary" onClick={openNew} style={{fontSize:".82rem",padding:"8px 16px"}}>+ A√±adir proveedor</button>
        </div>
      </div>

      {proveedores.length===0
        ?<div className="pm-empty">üè™ No hay proveedores todav√≠a. A√±ade el primero.</div>
        :<div className="pdb-grid">
          {proveedores.map(p=>(
            <div key={p.id} className="pdb-card">
              <div className="pdb-card-head">
                <div className="pdb-card-name">üè™ {p.nombre}</div>
                {p.nif&&<span style={{fontSize:".7rem",fontWeight:700,color:"var(--muted)"}}>{p.nif}</span>}
              </div>
              <div className="pdb-card-body">
                {p.email&&<div className="pdb-field"><span className="pdb-field-lbl">Email</span><span className="pdb-field-val"><a href={"mailto:"+p.email}>{p.email}</a></span></div>}
                {p.tel&&<div className="pdb-field"><span className="pdb-field-lbl">Tel.</span><span className="pdb-field-val">{p.tel}</span></div>}
                {p.fax&&<div className="pdb-field"><span className="pdb-field-lbl">Fax</span><span className="pdb-field-val">{p.fax}</span></div>}
                {p.direccion&&<div className="pdb-field"><span className="pdb-field-lbl">Direcci√≥n</span><span className="pdb-field-val">{p.direccion}{p.cp?" ¬∑ "+p.cp:""}{p.ciudad?" ¬∑ "+p.ciudad:""}</span></div>}
                {!p.email&&!p.tel&&!p.direccion&&<div style={{fontSize:".78rem",color:"var(--muted)",fontStyle:"italic"}}>Sin datos de contacto</div>}
              </div>
              <div className="pdb-card-actions">
                <button className="pdb-btn-edit" onClick={()=>openEdit(p)}>‚úèÔ∏è Editar</button>
                <button className="pdb-btn-del" onClick={()=>del(p)}>üóëÔ∏è</button>
              </div>
            </div>
          ))}
        </div>
      }

      {showModal&&(
        <div className="pdb-modal-overlay" onClick={e=>e.target===e.currentTarget&&setShowModal(false)}>
          <div className="pdb-modal">
            <h3>{editing===null?"‚ûï Nuevo proveedor":"‚úèÔ∏è Editar proveedor"}</h3>
            <div className="yellow-hint">‚≠ê Los campos completados se rellenar√°n autom√°ticamente en el Excel de pedido (celdas amarillas)</div>
            {err&&<div className="err-msg" style={{margin:"10px 0"}}>‚ö†Ô∏è {err}</div>}
            <div className="pdb-form-grid" style={{marginTop:14}}>
              {fields.map(f=>(
                <div key={f.k} className={"form-group"+(f.full?" full":"")} style={{marginBottom:0}}>
                  <label className="form-label">{f.lbl}</label>
                  <input className="form-input" placeholder={f.ph} value={form[f.k]} onChange={e=>sf(f.k,e.target.value)}/>
                </div>
              ))}
            </div>
            <div className="modal-footer" style={{marginTop:"1.25rem"}}>
              <button className="btn-sec" onClick={()=>setShowModal(false)}>Cancelar</button>
              <button className="btn-primary" onClick={save}>üíæ Guardar</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
function App(){
  const { useEffect } = React;
  const [orders,setOrders]       = useState(initialOrders);
  const [proyectos,setProyectos]   = useState([]);
  const [proveedores,setProveedores] = useState([]);
  const [filter,setFilter]       = useState("todos");
  const [search,setSearch]       = useState("");
  const [showNew,setShowNew]     = useState(false);
  const [showLogin,setShowLogin] = useState(false);
  const [isAdmin,setIsAdmin]     = useState(false);
  const [selected,setSelected]   = useState(null);
  const [tab,setTab]             = useState("pedidos");
  const [loading,setLoading]     = useState(true);

  useEffect(()=>{
    const iv = setInterval(()=>{
      const fb=getFB(); if(!fb) return;
      clearInterval(iv);
      fb.onSnapshot(fb.collection(fb.db,"orders"),snap=>{
        setOrders(snap.docs.map(d=>({...d.data(),_docId:d.id})));
        setLoading(false);
      });
      fb.onSnapshot(fb.collection(fb.db,"proyectos"),snap=>{
        setProyectos(snap.docs.map(d=>({...d.data(),_docId:d.id})));
      });
      fb.onSnapshot(fb.collection(fb.db,"proveedores"),snap=>{
        setProveedores(snap.docs.map(d=>({...d.data(),_docId:d.id})));
      });
    },300);
    return ()=>clearInterval(iv);
  },[]);

  const stats=useMemo(()=>({
    total:    orders.length,
    pendiente:orders.filter(o=>o.status==="pendiente").length,
    proceso:  orders.filter(o=>o.status==="proceso").length,
    recibido: orders.filter(o=>o.status==="recibido").length,
  }),[orders]);

  const filtered=useMemo(()=>orders.filter(o=>{
    if(filter!=="todos"&&o.status!==filter) return false;
    if(search.trim()){const s=search.toLowerCase();return o.responsable.toLowerCase().includes(s)||o.proveedor.toLowerCase().includes(s)||o.id.toLowerCase().includes(s)||o.products.some(p=>p.nombre.toLowerCase().includes(s))||((o.proyecto||"").toLowerCase().includes(s));}
    return true;
  }),[orders,filter,search]);

  const addOrder = async o=>{
    const fb=getFB();
    if(fb){ await fb.addDoc(fb.collection(fb.db,"orders"),o); }
    else { setOrders(p=>[o,...p]); }
    setShowNew(false);
  };
  const changeStatus=async(id,st)=>{
    const fb=getFB();
    const o=orders.find(x=>x.id===id);
    if(fb&&o?._docId){ await fb.updateDoc(fb.doc(fb.db,"orders",o._docId),{status:st}); }
    else { setOrders(p=>p.map(o=>o.id===id?{...o,status:st}:o)); }
    setSelected(p=>p&&p.id===id?{...p,status:st}:p);
  };
  const deleteOrder=async(id)=>{
    const fb=getFB();
    const o=orders.find(x=>x.id===id);
    if(fb&&o?._docId){ await fb.deleteDoc(fb.doc(fb.db,"orders",o._docId)); }
    else { setOrders(p=>p.filter(x=>x.id!==id)); }
    setSelected(null);
  };
  const asignarProyecto=async(id,proyecto)=>{
    const fb=getFB();
    const o=orders.find(x=>x.id===id);
    const nuevoStatus = proyecto ? "proceso" : o?.status||"pendiente";
    if(fb&&o?._docId){ await fb.updateDoc(fb.doc(fb.db,"orders",o._docId),{proyecto,status:nuevoStatus}); }
    else { setOrders(p=>p.map(x=>x.id===id?{...x,proyecto,status:nuevoStatus}:x)); }
    setSelected(p=>p&&p.id===id?{...p,proyecto,status:nuevoStatus}:p);
  };

  const SCARDS=[
    {cls:"sc-pink",  emoji:"üìã",num:stats.total,    label:"Total pedidos"},
    {cls:"sc-orange",emoji:"‚è≥",num:stats.pendiente,label:"Pendientes"},
    {cls:"sc-blue",  emoji:"üîÑ",num:stats.proceso,  label:"En proceso"},
    {cls:"sc-green", emoji:"‚úÖ",num:stats.recibido, label:"Recibidos"},
  ];

  return(
    <>
      <nav className="navbar">
        <div className="navbar-brand">
          <div className="nav-logo">üõí</div>
          Compras <span className="brand-dot">TQ</span>
        </div>
        <div className="navbar-right">
          {isAdmin
            ?<button className="btn-admin on" onClick={()=>{setIsAdmin(false);setTab("pedidos");}}>‚öôÔ∏è Admin ¬∑ Salir</button>
            :<button className="btn-admin" onClick={()=>setShowLogin(true)}>üîí Admin</button>}
          <button className="btn-primary" onClick={()=>setShowNew(true)}>+ Nueva Solicitud</button>
        </div>
      </nav>

      <main className="main">
        {loading&&<div style={{textAlign:"center",padding:"4rem",color:"var(--muted)"}}><div style={{fontSize:"2rem",marginBottom:"0.75rem"}}>‚è≥</div><div style={{fontWeight:700,fontSize:"1rem"}}>Conectando con la base de datos‚Ä¶</div></div>}
        {!loading&&<>
        {/* stat cards */}
        <div className="stats-grid">
          {SCARDS.map(s=>(
            <div key={s.cls} className={`stat-card ${s.cls}`}>
              <div className="stat-row">
                <div className="stat-num">{s.num}</div>
                <div className="stat-icon-pill">{s.emoji} {s.label}</div>
              </div>
              <div className="stat-label">{s.label}</div>
            </div>
          ))}
        </div>

        {/* tabs ‚Äî solo cuando es admin */}
        {isAdmin&&(
          <div className="tabs">
            <button className={`tab-btn${tab==="pedidos"?" act":""}`} onClick={()=>setTab("pedidos")}>üìã Pedidos</button>
            <button className={`tab-btn${tab==="resumen"?" act":""}`} onClick={()=>setTab("resumen")}>üìä Resumen</button>
            <button className={`tab-btn${tab==="proyectos"?" act":""}`} onClick={()=>setTab("proyectos")}>üìÅ Proyectos</button>
            <button className={`tab-btn${tab==="proveedores"?" act":""}`} onClick={()=>setTab("proveedores")}>üè™ Proveedores</button>
          </div>
        )}

        {/* CONTENT */}
        {tab==="proveedores"&&isAdmin
          ? <ProviderDB proveedores={proveedores} setProveedores={setProveedores}/>
          : tab==="proyectos"&&isAdmin
          ? <ProjectManager proyectos={proyectos} setProyectos={setProyectos}/>
          : tab==="resumen"&&isAdmin
          ? <Dashboard orders={orders} proyectos={proyectos} onAsignarProyecto={asignarProyecto} proveedores={proveedores}/>
          : (
          <>
            <div className="filters-section">
              <div className="search-wrap">
                <span className="search-icon">üîç</span>
                <input placeholder="Buscar por responsable, proveedor, proyecto o producto‚Ä¶" value={search} onChange={e=>setSearch(e.target.value)}/>
              </div>
              <div className="filter-pills">
                {STATUSES.map(s=>(
                  <button key={s.key} className={`filter-btn${filter===s.key?" act":""}`} onClick={()=>setFilter(s.key)}>{s.label}</button>
                ))}
              </div>
            </div>
            <div className="orders-list">
              {filtered.length===0
                ?<div className="empty-state"><span className="big">üì≠</span><p>Todav√≠a no hay solicitudes</p><small>Pulsa "+ Nueva Solicitud" para crear la primera</small></div>
                :filtered.map(o=>(
                  <div className="order-card" key={o.id} onClick={()=>setSelected(o)}>
                    <div className="order-card-left">
                      <div className="order-meta">
                        <span className="order-id">{o.id}</span>
                        <StatusTag status={o.status}/>
                        <CatTag cat={o.category}/>
                        {o.proyecto&&<span className="order-proj">üìÅ {o.proyecto}</span>}
                        <span className="order-date">{fmt(o.date)}</span>
                      </div>
                      <div className="order-info">
                        <span>Responsable <b>{o.responsable}</b></span>
                        <span>Proveedor <b>{o.proveedor}</b></span>
                        <span>Art√≠culos <b>{o.products.length}</b></span>
                      </div>
                      <div className="order-chips">
                        {o.products.slice(0,3).map((p,i)=><span key={i} className="chip">{p.nombre}</span>)}
                        {o.products.length>3&&<span className="chip">+{o.products.length-3} m√°s</span>}
                      </div>
                    </div>
                    <div className="order-right">
                      <div className="order-total-num">{eur(tot(o.products))}</div>
                      <div className="order-total-lbl">total</div>
                    </div>
                  </div>
                ))
              }
            </div>
          </>
        )}
        </>}
      </main>
      {showNew   &&<NewRequestModal onClose={()=>setShowNew(false)} onSubmit={addOrder} proyectos={proyectos} proveedores={proveedores}/>}
      {showLogin &&<LoginModal onClose={()=>setShowLogin(false)} onSuccess={()=>{setIsAdmin(true);setShowLogin(false);}}/>}
      {selected  &&<OrderDetailModal order={selected} isAdmin={isAdmin} onClose={()=>setSelected(null)} onStatusChange={changeStatus} onDelete={deleteOrder} proyectos={proyectos} onAsignarProyecto={asignarProyecto}/>}
    </>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
